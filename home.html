<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>DevTravels</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-9ndCyUaIbzAi2FUVXJi0CjmCapSmO7SnpJef0486qhLnuZ2cdeRhO02iuK6FUUVM" crossorigin="anonymous">
  <link rel="stylesheet" href="/css/style.css">
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css">
</head>

<body>

  <!--Navbar starts-->
  <nav class="navbar navbar-expand-lg bg-body-tertiary">
    <div class="container-fluid">
      <a class="navbar-brand" href="home.html">DevTravels</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
        aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav">
          <li class="nav-item">
            <a class="nav-link active" aria-current="page" href="home.html">Home</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="mybookings.html">My Bookings</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#" id="logoutBtn">Log Out</a>
          </li>
        </ul>
      </div>
    </div>
  </nav>
  <!--navbar ends-->


  <div class="container" style="display: flex; flex-direction: row;">

    <!--Gif Starts-->
    <div class="left">
      <img src="/assets/leftGif.gif" alt="Gif of aeroplane" srcset="">
    </div>
    <!--Gif ends-->
    <!--Bookinig container Starts-->
    <div class="right">
      <div class="bookFlight">
        <form id="myForm">
          <input type="text" id="source" placeholder="Enter source" required />
          <input type="text" id="destination" placeholder="Enter destination" required />
          <input type="date" id="date" placeholder="Enter date" required />
          <p class="text-center text-success" id="warning"></p>

          <input type="submit" class="button" id="findFlight" value="Find Flight" />
          <p id="notfound" style="display: none;">No flights found :(</p>
        </form>
      </div>
    </div>

    <!--Booking Container Ends-->
  </div>


  <!--Search Result starts-->
  <!--show results when searched-->
  <div class="searchResult" id="result" style="display: none;">
    <div class="datatables">
      <div class="box">
        <!-- DataTales Example -->
        <div class="width card shadow-lg mb-4">
          <div class="card-header py-3">
            <h6 class="m-0 font-weight-bold text-primary">Search Result :</h6>
          </div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-bordered" id="dataTable" width="100%" cellspacing="0">
                <thead>
                  <tr>

                    <th>Flight Id</th>
                    <th>Source</th>
                    <th>Destination</th>
                    <th>Time</th>
                    <th>Price</th>
                    <th>Book</th>
                  </tr>
                </thead>
                <tfoot>
                  <tr>
                    <th>Flight Id</th>
                    <th>Source</th>
                    <th>Destination</th>
                    <th>Time</th>
                    <th>Price</th>
                    <th>Book</th>
                  </tr>
                </tfoot>
                <tbody id="flights">
                  <!-- <tr>
                               <td>Date</td>
                               <td>Status</td>
                               <td>Location</td>
                               <td>Action</td>
                           </tr> -->
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!--Search Result Ends-->

  <!--Top Travels Starts-->

  <h2>Top Travels In India :</h2>
  <div class="box">
    <div class="card" style="width: 18rem;">
      <img src="/assets/delhi.jpg" class="card-img-top" alt="delhi image" style="height: 200px;">
      <div class="card-body">
        <p class="card-text">Experience the vibrant blend of history, culture, and modernity in the heart of India with
          Delhi tourism.</p>
      </div>
    </div>

    <div class="card" style="width: 18rem;">
      <img src="/assets/hyderabad.jpg" class="card-img-top" alt="hyderabad image" style="height: 200px;">
      <div class="card-body">
        <p class="card-text">"Embark on a captivating journey to Hyderabad, where tradition meets technology. Explore
          ancient forts, taste delectable biryanis.</p>
      </div>
    </div>


    <div class="card" style="width: 18rem;">
      <img src="/assets/goa.webp" class="card-img-top" alt="goa image" style="height: 200px;">
      <div class="card-body">
        <p class="card-text">Escape to paradise on the sun-kissed shores of Goa. With its pristine beaches, vibrant
          nightlife,water sports.</p>
      </div>
    </div>

    <div class="card" style="width: 18rem;">
      <img src="/assets/agra.jpg" class="card-img-top" alt="agra image" style="height: 200px;">
      <div class="card-body">
        <p class="card-text">Journey to Agra and witness the eternal beauty of the Taj Mahal, a UNESCO World Heritage
          site. Explore the rich Mughal history.</p>
      </div>
    </div>

    <div class="card" style="width: 18rem;">
      <img src="/assets/varanasi.jpg" class="card-img-top" alt="varanasi image" style="height: 200px;">
      <div class="card-body">
        <p class="card-text">Experience the spiritual soul of India in Varanasi, where ancient traditions and sacred
          rituals unfold along the banks of River Ganga.</p>
      </div>
    </div>
  </div>
  <!--Top Travels Ends-->


  <!-- Button trigger modal -->
  <button type="button" style="display: none;" id="launchModal" class="btn btn-primary" data-bs-toggle="modal"
    data-bs-target="#staticBackdrop">
  </button>



  <!-- Modal -->
  <div class="modal fade " id="staticBackdrop" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1"
    aria-labelledby="staticBackdropLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered modal-fullscreen-xl-down modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h1 class="modal-title fs-5" id="staticBackdropLabel">Book Your Flights</h1>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="card mb-3">
            <input type="number" placeholder="Enter Number of seats" id="seats">
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" id="bookBtn">Book</button>
          <input style="display:none" ; value="" id="modalInvoiceId"></input>
        </div>
      </div>
    </div>
  </div>

  <!--footer starts-->
  <footer>
    <center>
      <p>
        Mohd Aiman Saleem |
        DevRev &copy; 2023
      </p>

    </center>
  </footer>

  <!--footer ends-->
  <script src="https://code.jquery.com/jquery-3.7.0.js" integrity="sha256-JlqSTELeR4TLqP0OG9dxM7yDPqX1ox/HfgiSLBj8+kM="
    crossorigin="anonymous"></script>
  <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-geWF76RCwLtnZ8qwWowPQNguL3RmwHVBC9FhGdlKrxdiJJigb/j/68SIy3Te4Bkz"
    crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-geWF76RCwLtnZ8qwWowPQNguL3RmwHVBC9FhGdlKrxdiJJigb/j/68SIy3Te4Bkz"
    crossorigin="anonymous"></script>

  <script type="module">
    // Import the functions you need from the SDKs you need
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-analytics.js";
    import { getAuth, onAuthStateChanged, signOut, signInWithEmailAndPassword, updatePassword, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
    import { getDatabase, ref as dRef, set, get, child, update, push, remove } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";
    // For Firebase JS SDK v7.20.0 and later, measurementId is optional
    const firebaseConfig = {
      apiKey: "AIzaSyC0aq5bOk4XaSt88ZZ07PSAoslmUSkkQvA",
      authDomain: "devrevs.firebaseapp.com",
      databaseURL: "https://devrevs-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "devrevs",
      storageBucket: "devrevs.appspot.com",
      messagingSenderId: "766013496767",
      appId: "1:766013496767:web:908755e2328056adead50a",
      measurementId: "G-V23KVPT9T3"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const analytics = getAnalytics(app);

    const form = document.getElementById("myForm");
    form.addEventListener("submit", searchFlights);

    function searchFlights(event) {
      event.preventDefault();

      clearTable();
      const source = document.getElementById("source").value;
      const destination = document.getElementById("destination").value;
      const date = document.getElementById("date").value;

      //populating the dataTable
      const dbRef = dRef(getDatabase());


      let foundres = false;
      get(child(dbRef, `/flights`)).then((snapshot) => {

        if (snapshot.exists()) {
          let invoiceObj = {};

          snapshot.forEach(function (childSnapshot) {
            invoiceObj = childSnapshot.val();
            invoiceObj['flightID'] = childSnapshot.key;
            if (invoiceObj.source == source && invoiceObj.destination == destination && invoiceObj.date == date) {
              addTableRow(`${invoiceObj.flightID}`, `${invoiceObj.source}`, `${invoiceObj.destination}`, `${invoiceObj.time}`, `${invoiceObj.fare}`, `<button type="button" class="btn btn-primary btn-sm" onclick="openInvoice('${invoiceObj.flightID}')">Book</button>`);
              document.getElementById("result").style.display = 'block';
              document.getElementById('modalInvoiceId').value = invoiceObj.flightID;
              foundres = true;
            }
          });
        }
      }
      ).catch((error) => {
        console.error(error);
      }
      );

      // datatable populating end 
      function addTableRow(a, b, c, d, e, f) {
        var table = $('#dataTable').DataTable();
        table.row.add([a, b, c, d, e, f]).draw();
      }
      function clearTable() {
        var table = $('#dataTable').DataTable();
        table.clear().draw();
      }
    }


    document.getElementById('logoutBtn').addEventListener('click', () => {
      signOut(auth)
        .then(() => {
          localStorage.removeItem("DevTravels");
          window.location = 'index.html';
        })
        .catch((error) => {
          console.log(error);
        });
    });


    document.getElementById('bookBtn').addEventListener('click', () => {

      const dbRef = dRef(getDatabase());
      const updates = {};
      const updates2 = {};
      var ans = 60;
      const db = getDatabase();
      const id = document.getElementById('modalInvoiceId').value;

      var pres = document.getElementById("seats").value;
      get(child(dbRef, '/flights/' + `${id}`)).then((snapshot) => {
        if (snapshot.exists()) {
          ans = snapshot.val().seatsAvail - pres;
          if (ans < 0) {
            alert("Can't book the tickets as we dont have enought seats :(")
          } else {
            updates[`/flights/` + id + '/seatsAvail'] = ans;
            update(dRef(db), updates);


            const userObj = JSON.parse(localStorage.getItem("DevTravels"));
            var user = userObj['user'];
            var flightID = document.getElementById('modalInvoiceId').value;

            updates2['/user/' + `${user}` + "/" + `${flightID}`] = snapshot.val();
            update(dRef(db), updates2);
            alert("sucessfully booked tickets");
          }

        }
      });
    })
  </script>

  <script>
    function openInvoice(id) {
      document.getElementById('launchModal').click();
    }

    function customSearch(e) {
      $('#dataTable').DataTable().search(e.innerHTML.split(':')[0]).draw();
    }

  </script>

</body>

</html>
